<!-- templates/checkout.html -->
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Checkout - KCX Crochet</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
      body { background:#fff8f4; }
      .container { max-width: 800px; }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-light bg-white shadow-sm mb-4">
      <div class="container">
        <a class="navbar-brand" href="/">KCX Crochet</a>
        <a class="nav-link" href="/shop">Shop</a>
      </div>
    </nav>

    <main class="container">
      <h2 class="mb-3">Checkout</h2>

      <!-- CART SUMMARY (read-only) -->
      <div class="card mb-3">
        <div class="card-body">
          <h6>Order summary</h6>
          <ul class="list-unstyled mb-0">
            {% for item in cart_items %}
            <li class="d-flex justify-content-between">
              <div>{{ item.product.name }} × {{ item.quantity }}</div>
              <div>₹{{ item.product.price * item.quantity }}</div>
            </li>
            {% endfor %}
          </ul>

          <hr>
          <div class="d-flex justify-content-between fw-bold">
            <div>Total</div>
            <div>₹{{ total }}</div>
          </div>
        </div>
      </div>

      <!-- CHECKOUT FORM -->
      <form id="checkoutForm" method="POST" class="card p-3 mb-3">
        <div class="mb-3">
          <label class="form-label">Full name</label>
          <input name="name" class="form-control" required placeholder="Your name" />
        </div>

        <div class="row">
          <div class="col-md-6 mb-3">
            <label class="form-label">Phone</label>
            <input name="phone" class="form-control" required placeholder="Phone number" />
          </div>
          <div class="col-md-6 mb-3">
            <label class="form-label">Email (optional)</label>
            <input name="email" class="form-control" placeholder="you@example.com" />
          </div>
        </div>

        <div class="mb-3">
          <label class="form-label">Address</label>
          <textarea name="address" rows="2" class="form-control" required placeholder="Street, house no."></textarea>
        </div>

        <div class="row">
          <div class="col-md-6 mb-3">
            <label class="form-label">City</label>
            <input name="city" class="form-control" required />
          </div>
          <div class="col-md-6 mb-3">
            <label class="form-label">Pincode</label>
            <input name="pincode" class="form-control" required />
          </div>
        </div>

        <div class="mb-3">
          <label class="form-label">Notes (optional)</label>
          <textarea name="notes" rows="2" class="form-control" placeholder="Anything to tell us?"></textarea>
        </div>

        <!-- Pay button (JS handles creating order and opening Razorpay) -->
        <div class="d-grid">
          <button id="payBtn" type="button" class="btn btn-dark">Pay Securely with Razorpay</button>
        </div>
      </form>

      <a href="/shop" class="btn btn-outline-secondary">Continue shopping</a>
    </main>

    <!-- Razorpay + handler -->
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function () {
      const payBtn = document.getElementById("payBtn");
      const form = document.getElementById("checkoutForm");

      payBtn.addEventListener("click", function () {
        // basic client-side validation
        if (!form.checkValidity()) {
          form.reportValidity();
          return;
        }

        // 1) create local order via AJAX
        fetch("/checkout_ajax", {
          method: "POST",
          body: new FormData(form)
        })
        .then(r => r.json())
        .then(data => {
          if (!data || data.error) {
            alert("Could not create order: " + (data && data.error || "unknown"));
            return;
          }
          const localOrderId = data.order_id;

          // 2) request razorpay order
          return fetch("/create_order", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ order_id: localOrderId })
          })
          .then(r => r.json())
          .then(payload => {
            if (!payload || payload.error) {
              alert("Could not create Razorpay order: " + (payload && payload.error || "unknown"));
              return;
            }

            const options = {
              key: payload.key,
              amount: payload.amount,
              currency: payload.currency || "INR",
              name: "KCX Crochet Store",
              description: "Order Payment",
              order_id: payload.razorpay_order_id,
              handler: function (response) {
                // verify payment server-side
                fetch("/verify_payment", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({
                    razorpay_order_id: response.razorpay_order_id,
                    razorpay_payment_id: response.razorpay_payment_id,
                    razorpay_signature: response.razorpay_signature,
                    local_order_id: localOrderId
                  })
                })
                .then(r => r.json())
                .then(result => {
                  if (result.status === "success") {
                    window.location.href = "/order-success/" + localOrderId;
                  } else {
                    alert("Payment verification failed");
                  }
                }).catch(e => { console.error(e); alert("Verification request failed"); });
              },
              theme: { color: "#F4D3C4" }
            };

            const rzp = new Razorpay(options);
            rzp.open();
          });
        })
        .catch(err => {
          console.error(err);
          alert("Network error while creating order.");
        });
      });
    });
    </script>

  </body>
</html>
