{% extends "base.html" %}

{% block title %}{% if product %}Edit{% else %}Add{% endif %} Product | Admin{% endblock %}

{% block content %}
<div class="container py-5">
  <a href="{{ url_for('admin_products') }}" class="btn btn-sm btn-outline-secondary mb-3">← Back to products</a>

  <div class="card shadow-sm border-0">
    <div class="card-body p-4">
      <h4 class="mb-4 fw-bold">{% if product %}Edit{% else %}Add{% endif %} Product</h4>

      <form method="post" enctype="multipart/form-data" id="productForm">
        <div class="mb-4">
          <label class="form-label fw-semibold">Name</label>
          <input name="name" class="form-control form-control-lg" value="{{ product.name if product else '' }}" required>
        </div>

        <div class="mb-4">
          <label class="form-label fw-semibold">Price (₹)</label>
          <input name="price" type="number" class="form-control form-control-lg" value="{{ product.price if product else '' }}" required>
        </div>

        <div class="mb-4">
          <label class="form-label fw-semibold">Description</label>
          <textarea name="description" class="form-control" rows="4">{{ product.description if product else '' }}</textarea>
        </div>

        <div class="mb-4">
          <label class="form-label fw-semibold">Category</label>
          <select name="category" class="form-select form-select-lg" required>
            <option value="">-- Select Category --</option>
            {% for category in categories %}
              <option value="{{ category }}" {% if product and product.category == category %}selected{% endif %}>{{ category }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- IMAGE MANAGEMENT -->
        <div class="mb-4">
          <label class="form-label fw-semibold d-block mb-3">
            <i class="bi bi-images"></i> Product Images
          </label>
          
          {% if product and product.images %}
            <div class="mb-4">
              <div class="d-flex align-items-center justify-content-between mb-3">
                <p class="text-muted small mb-0">
                  Current Gallery ({{ product.images|length }} images) 
                  <span class="badge bg-info ms-2"><i class="bi bi-arrows-move"></i> Drag to reorder</span>
                </p>
                {% if product.images|length > 0 %}
                  <button type="button" class="btn btn-sm btn-outline-danger" id="deleteAllBtn">
                    <i class="bi bi-trash"></i> Delete All
                  </button>
                {% endif %}
              </div>
              
              <div id="existingImagesGrid" class="row g-3 mb-4">
                {% for img in product.images %}
                  <div class="col-6 col-md-4 col-lg-3 image-card" data-image-id="{{ img.id }}" draggable="true">
                    <div class="position-relative image-wrapper">
                      <div class="drag-handle"><i class="bi bi-grip-vertical"></i></div>
                      <img src="{{ url_for('static', filename=img.image_url) }}" alt="Product" class="img-fluid rounded shadow-sm">
                      <div class="image-overlay">
                        <button type="button" class="btn btn-sm btn-light set-main-btn" data-image-id="{{ img.id }}" title="Set as main">
                          <i class="bi bi-star"></i>
                        </button>
                        <button type="button" class="btn btn-sm btn-danger delete-image-btn" data-image-id="{{ img.id }}">
                          <i class="bi bi-trash"></i>
                        </button>
                      </div>
                      {% if loop.index == 1 %}
                        <span class="badge bg-warning text-dark position-absolute top-0 start-0 m-2">
                          <i class="bi bi-star-fill"></i> Main
                        </span>
                      {% endif %}
                    </div>
                  </div>
                {% endfor %}
              </div>
              <input type="hidden" name="image_order" id="imageOrderInput">
            </div>
          {% endif %}

          <div class="upload-section">
            <label for="imageInput" class="upload-label">
              <div class="upload-area">
                <i class="bi bi-cloud-upload display-4 text-primary mb-3"></i>
                <h5 class="mb-2">Drop images here or click to browse</h5>
                <p class="text-muted small mb-0">Supports: JPG, PNG (Recommended: 800×800px)</p>
              </div>
            </label>
            <input id="imageInput" name="images" type="file" class="d-none" accept="image/*" multiple>
          </div>

          <div id="imagePreview" class="row g-3 mt-3"></div>

          <div class="form-text mt-2">
            <i class="bi bi-info-circle"></i> First image is the main image. Drag to reorder or click star to set as main.
          </div>
        </div>

        <!-- COLOR VARIANTS -->
        <div class="mb-4">
          <label class="form-label fw-semibold d-block mb-3">
            <i class="bi bi-palette"></i> Color Variants (Optional)
          </label>
          <div class="border rounded p-3 bg-light">
            <div id="colorVariantList"></div>
            <button type="button" class="btn btn-sm btn-outline-primary mt-2" id="addColorBtn">
              <i class="bi bi-plus-circle"></i> Add Color
            </button>
          </div>
          <div class="form-text mt-2">Add colors and map images to each variant.</div>
        </div>

        <!-- SIZE VARIANTS -->
        <div class="mb-4">
          <label class="form-label fw-semibold d-block mb-3">
            <i class="bi bi-rulers"></i> Size Variants (Optional)
          </label>
          <div class="border rounded p-3 bg-light">
            <div id="sizeVariantList"></div>
            <button type="button" class="btn btn-sm btn-outline-primary mt-2" id="addSizeBtn">
              <i class="bi bi-plus-circle"></i> Add Size
            </button>
          </div>
          <div class="form-text mt-2">Add sizes and optionally map images.</div>
        </div>

        <input type="hidden" name="color_variants" id="colorVariantsData">
        <input type="hidden" name="size_variants" id="sizeVariantsData">

        <div class="mb-4">
          <label class="form-label fw-semibold">Sale Price (Optional)</label>
          <input name="sale_price" type="number" class="form-control form-control-lg" value="{{ product.sale_price if product and product.sale_price else '' }}" placeholder="Leave empty if not on sale">
        </div>

        <div class="mb-4">
          <label class="form-label fw-semibold d-block mb-3">Product Tags</label>
          <div class="form-check mb-2">
            <input class="form-check-input" type="checkbox" name="is_bestseller" id="best" {% if product and product.is_bestseller %}checked{% endif %}>
            <label class="form-check-label fw-semibold" for="best">
              <span class="badge bg-danger me-2">Bestseller</span> Mark as Bestseller
            </label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="is_new_launch" id="newLaunch" {% if product and product.is_new_launch %}checked{% endif %}>
            <label class="form-check-label fw-semibold" for="newLaunch">
              <span class="badge bg-success me-2">New Launch</span> Mark as New Launch
            </label>
          </div>
        </div>

        <div class="d-flex gap-2">
          <button class="btn btn-dark btn-lg px-4" type="submit">
            <i class="bi bi-check-circle"></i> {% if product %}Save Changes{% else %}Create Product{% endif %}
          </button>
          <a href="{{ url_for('admin_products') }}" class="btn btn-outline-secondary btn-lg px-4">Cancel</a>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Crop Modal -->
<div class="modal fade" id="cropModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="bi bi-crop"></i> Crop Image 
          <span class="badge bg-primary ms-2" id="cropCounter"></span>
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="crop-container" style="max-height: 500px; overflow: hidden;">
          <img id="cropImage" style="max-width: 100%; display: block;">
        </div>
        <div class="mt-3">
          <p class="small text-muted mb-2">
            <i class="bi bi-info-circle"></i> Drag to move, scroll to zoom. Recommended: Square crop (1:1 ratio)
          </p>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" id="skipCrop">
          <i class="bi bi-skip-forward"></i> Skip Crop
        </button>
        <button type="button" class="btn btn-primary" id="cropAndSave">
          <i class="bi bi-crop"></i> Crop & Continue
        </button>
      </div>
    </div>
  </div>
</div>

<style>
.card{border-radius:12px}
.upload-label{cursor:pointer;display:block}
.upload-area{border:3px dashed #dee2e6;border-radius:12px;padding:3rem 2rem;text-align:center;transition:all .3s;background:#f8f9fa}
.upload-area:hover,.upload-area.dragover{border-color:#0d6efd;background:#e7f1ff;transform:translateY(-2px)}
.image-card{transition:transform .2s,opacity .2s;cursor:move}
.image-card.dragging{opacity:.5;transform:scale(.95)}
.drag-handle{position:absolute;top:5px;right:5px;background:rgba(255,255,255,.9);padding:5px 8px;border-radius:4px;cursor:move;z-index:10;font-size:1.2rem;color:#666}
.image-wrapper{position:relative;overflow:hidden;border-radius:8px;aspect-ratio:1}
.image-wrapper img{width:100%;height:100%;object-fit:cover;transition:transform .3s}
.image-overlay{position:absolute;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.7);display:flex;gap:.5rem;align-items:center;justify-content:center;opacity:0;transition:opacity .3s}
.image-wrapper:hover .image-overlay{opacity:1}
.image-wrapper:hover img{transform:scale(1.05)}
.preview-wrapper{position:relative;overflow:hidden;border-radius:8px;aspect-ratio:1;border:2px solid #dee2e6;background:#fff}
.preview-wrapper img{width:100%;height:100%;object-fit:cover}
.preview-wrapper .btn{z-index:10}
.variant-item{background:#fff;border:1px solid #dee2e6;border-radius:8px;padding:1rem;margin-bottom:.75rem}
.color-preview{width:40px;height:40px;border-radius:50%;border:2px solid #dee2e6;display:inline-block}
.img-checkbox{width:60px;height:60px;border:2px solid #dee2e6;border-radius:4px;overflow:hidden;cursor:pointer;transition:all .2s}
.img-checkbox.selected{border-color:#0d6efd;box-shadow:0 0 0 3px rgba(13,110,253,.2)}
.img-checkbox img{width:100%;height:100%;object-fit:cover}
.cropper-view-box,.cropper-face{border-radius:0}
.cropper-container{max-height:500px}
</style>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>

<script>
// PART 1: Variables and Initial Setup
const input=document.getElementById("imageInput");
const preview=document.getElementById("imagePreview");
const uploadArea=document.querySelector(".upload-area");
const existingGrid=document.getElementById("existingImagesGrid");

let files=[];
let allImages=[];
let colorVariants=[];
let sizeVariants=[];
let colorCounter=0;
let sizeCounter=0;
let cropper=null;
let currentImageFile=null;
let imagesToProcess=[];
let currentProcessIndex=0;
let cropModalInstance=null;

// LOAD EXISTING VARIANTS FROM SERVER
{% if product %}
const existingColorVariants = {{ existing_color_variants|safe }};
const existingSizeVariants = {{ existing_size_variants|safe }};
{% else %}
const existingColorVariants = [];
const existingSizeVariants = [];
{% endif %}

function preventDefaults(e){e.preventDefault();e.stopPropagation();}

['dragenter','dragover','dragleave','drop'].forEach(e=>uploadArea.addEventListener(e,preventDefaults,!1));
['dragenter','dragover'].forEach(e=>uploadArea.addEventListener(e,()=>uploadArea.classList.add('dragover')));
['dragleave','drop'].forEach(e=>uploadArea.addEventListener(e,()=>uploadArea.classList.remove('dragover')));

uploadArea.addEventListener('drop',e=>handleFiles(e.dataTransfer.files));
uploadArea.addEventListener('click',()=>input.click());
input.addEventListener("change",()=>handleFiles(input.files));

function handleFiles(fileList){
  imagesToProcess=Array.from(fileList);
  currentProcessIndex=0;
  if(imagesToProcess.length>0){
    showCropModal(imagesToProcess[currentProcessIndex]);
  }
}

function showCropModal(file){
  currentImageFile=file;
  const reader=new FileReader();
  
  reader.onload=function(e){
    const cropImage=document.getElementById('cropImage');
    cropImage.src=e.target.result;
    
    document.getElementById('cropCounter').textContent=`${currentProcessIndex+1} of ${imagesToProcess.length}`;
    
    const modalEl=document.getElementById('cropModal');
    cropModalInstance=new bootstrap.Modal(modalEl);
    cropModalInstance.show();
    
    modalEl.addEventListener('shown.bs.modal',function(){
      if(cropper) cropper.destroy();
      cropper=new Cropper(cropImage,{
        aspectRatio:1,
        viewMode:1,
        autoCropArea:1,
        responsive:true,
        background:false,
        zoomable:true,
        scalable:true,
        cropBoxResizable:true,
        cropBoxMovable:true
      });
    },{once:true});
  };
  
  reader.readAsDataURL(file);
}

document.getElementById('cropAndSave').addEventListener('click',function(){
  if(!cropper) return;
  
  cropper.getCroppedCanvas({
    width:800,
    height:800,
    imageSmoothingEnabled:true,
    imageSmoothingQuality:'high'
  }).toBlob(function(blob){
    const croppedFile=new File([blob],currentImageFile.name,{
      type:currentImageFile.type,
      lastModified:Date.now()
    });
    
    files.push(croppedFile);
    processNextImage();
  },'image/jpeg',0.95);
});

document.getElementById('skipCrop').addEventListener('click',function(){
  files.push(currentImageFile);
  processNextImage();
});

function processNextImage(){
  currentProcessIndex++;
  
  if(currentProcessIndex<imagesToProcess.length){
    if(cropper){
      cropper.destroy();
      cropper=null;
    }
    showCropModal(imagesToProcess[currentProcessIndex]);
  }else{
    closeModalAndFinish();
  }
}

function closeModalAndFinish(){
  if(cropper){
    cropper.destroy();
    cropper=null;
  }
  
  if(cropModalInstance){
    cropModalInstance.hide();
  }
  
  setTimeout(()=>{
    const backdrop=document.querySelector('.modal-backdrop');
    if(backdrop) backdrop.remove();
    document.body.classList.remove('modal-open');
    document.body.style.overflow='';
    document.body.style.paddingRight='';
    
    renderPreview();
    updateAllImages();
    input.value='';
    imagesToProcess=[];
    currentProcessIndex=0;
  },300);
}

document.getElementById('cropModal').addEventListener('hidden.bs.modal',function(){
  if(cropper){
    cropper.destroy();
    cropper=null;
  }
  
  const backdrop=document.querySelector('.modal-backdrop');
  if(backdrop) backdrop.remove();
  document.body.classList.remove('modal-open');
  document.body.style.overflow='';
  document.body.style.paddingRight='';
  
  imagesToProcess=[];
  currentProcessIndex=0;
  input.value='';
});

// PART 2: Continue from PART 1

function renderPreview(){
  preview.innerHTML="";
  
  files.forEach((file,idx)=>{
    const reader=new FileReader();
    
    reader.onload=function(e){
      const col=document.createElement("div");
      col.className="col-6 col-md-4 col-lg-3";
      
      const wrapper=document.createElement("div");
      wrapper.className="preview-wrapper position-relative";
      
      const img=document.createElement("img");
      img.src=e.target.result;
      img.alt="Preview";
      
      const deleteBtn=document.createElement("button");
      deleteBtn.type="button";
      deleteBtn.className="btn btn-sm btn-danger position-absolute top-0 end-0 m-2";
      deleteBtn.innerHTML='<i class="bi bi-trash"></i>';
      deleteBtn.onclick=()=>{
        files.splice(idx,1);
        renderPreview();
        updateFileInput();
      };
      
      if(idx===0){
        const badge=document.createElement("span");
        badge.className="badge bg-primary position-absolute top-0 start-0 m-2";
        badge.innerHTML='<i class="bi bi-star-fill"></i> Main';
        wrapper.appendChild(badge);
      }
      
      wrapper.appendChild(img);
      wrapper.appendChild(deleteBtn);
      col.appendChild(wrapper);
      preview.appendChild(col);
    };
    
    reader.readAsDataURL(file);
  });
}

function updateFileInput(){
  const dt=new DataTransfer();
  files.forEach(f=>dt.items.add(f));
  input.files=dt.files;
  updateAllImages();
}

function updateAllImages(){
  allImages=[];
  
  if(existingGrid){
    const existingImgs=existingGrid.querySelectorAll('.image-card img');
    existingImgs.forEach(img=>allImages.push({src:img.src,type:'existing'}));
  }
  
  let processedCount=0;
  files.forEach((file,idx)=>{
    const reader=new FileReader();
    reader.onload=function(e){
      allImages.push({src:e.target.result,type:'new',file:file});
      processedCount++;
      if(processedCount===files.length){
        updateVariantSelectors();
      }
    };
    reader.readAsDataURL(file);
  });
  
  if(files.length===0){
    updateVariantSelectors();
  }
}

if(existingGrid){
  new Sortable(existingGrid,{
    animation:150,
    handle:'.drag-handle',
    onEnd:()=>{
      updateImageOrder();
      updateMainBadge();
    }
  });

  function updateImageOrder(){
    const order=Array.from(existingGrid.querySelectorAll('.image-card')).map(e=>e.dataset.imageId);
    document.getElementById('imageOrderInput').value=JSON.stringify(order);
  }

  function updateMainBadge(){
    const cards=existingGrid.querySelectorAll('.image-card');
    cards.forEach((card,idx)=>{
      const existingBadge=card.querySelector('.badge.bg-warning');
      if(existingBadge) existingBadge.remove();
      
      if(idx===0){
        const badge=document.createElement('span');
        badge.className='badge bg-warning text-dark position-absolute top-0 start-0 m-2';
        badge.innerHTML='<i class="bi bi-star-fill"></i> Main';
        card.querySelector('.image-wrapper').appendChild(badge);
      }
    });
  }

  document.querySelectorAll('.set-main-btn').forEach(btn=>{
    btn.addEventListener('click',function(){
      const imgId=this.getAttribute('data-image-id');
      const card=document.querySelector(`[data-image-id="${imgId}"]`);
      if(card&&existingGrid){
        existingGrid.insertBefore(card,existingGrid.firstChild);
        updateImageOrder();
        updateMainBadge();
      }
    });
  });

  document.querySelectorAll('.delete-image-btn').forEach(btn=>{
    btn.addEventListener('click',function(){
      const imgId=this.getAttribute('data-image-id');
      if(confirm('Delete this image?')){
        deleteImage(imgId);
      }
    });
  });

  document.getElementById('deleteAllBtn')?.addEventListener('click',function(){
    if(confirm('Delete all images?')){
      const imageIds=Array.from(document.querySelectorAll('.delete-image-btn')).map(btn=>btn.getAttribute('data-image-id'));
      imageIds.forEach(id=>deleteImage(id));
    }
  });

  function deleteImage(imgId){
    fetch(`/admin/products/delete-image/${imgId}`,{
      method:'POST',
      headers:{'Content-Type':'application/json'}
    })
    .then(r=>r.json())
    .then(data=>{
      if(data.success){
        const card=document.querySelector(`[data-image-id="${imgId}"]`);
        if(card){
          card.style.opacity='0';
          setTimeout(()=>{
            card.remove();
            updateImageOrder();
            updateMainBadge();
            updateAllImages();
          },300);
        }
      }else{
        alert('Failed to delete');
      }
    })
    .catch(()=>alert('Failed to delete'));
  }
}

// COLOR VARIANT FUNCTIONS
document.getElementById('addColorBtn').addEventListener('click',()=>addColorVariant());

function addColorVariant(data=null){
  const id=data?data.id:`c${colorCounter++}`;
  const item=document.createElement('div');
  item.className='variant-item';
  item.dataset.variantId=id;
  item.innerHTML=`
    <div class="d-flex justify-content-between align-items-start mb-2">
      <h6 class="mb-0">Color Variant</h6>
      <button type="button" class="btn btn-sm btn-outline-danger remove-variant"><i class="bi bi-x"></i></button>
    </div>
    <div class="row g-2 mb-2">
      <div class="col-md-5">
        <input type="text" class="form-control color-name" placeholder="Color name" value="${data?data.name:''}">
      </div>
      <div class="col-md-3">
        <input type="color" class="form-control color-code" value="${data?data.code:'#000000'}">
      </div>
      <div class="col-md-4">
        <input type="number" class="form-control color-price" placeholder="Price adj." value="${data?data.price_adj:''}">
      </div>
    </div>
    <div class="image-selector" id="colorImg${id}"></div>
  `;
  document.getElementById('colorVariantList').appendChild(item);
  item.querySelector('.remove-variant').onclick=()=>item.remove();
  
  // Pre-select images if data provided
  if(data && data.images){
    setTimeout(()=>{
      const selector=item.querySelector('.image-selector');
      const checkboxes=selector.querySelectorAll('.img-checkbox');
      data.images.forEach(imgIdx=>{
        if(checkboxes[imgIdx]){
          checkboxes[imgIdx].classList.add('selected');
        }
      });
    },100);
  }
  
  updateVariantSelectors();
}

// SIZE VARIANT FUNCTIONS
document.getElementById('addSizeBtn').addEventListener('click',()=>addSizeVariant());

function addSizeVariant(data=null){
  const id=data?data.id:`s${sizeCounter++}`;
  const item=document.createElement('div');
  item.className='variant-item';
  item.dataset.variantId=id;
  item.innerHTML=`
    <div class="d-flex justify-content-between align-items-start mb-2">
      <h6 class="mb-0">Size Variant</h6>
      <button type="button" class="btn btn-sm btn-outline-danger remove-variant"><i class="bi bi-x"></i></button>
    </div>
    <div class="row g-2 mb-2">
      <div class="col-md-6">
        <input type="text" class="form-control size-name" placeholder="Size (S, M, L, etc.)" value="${data?data.name:''}">
      </div>
      <div class="col-md-6">
        <input type="number" class="form-control size-price" placeholder="Price adjustment" value="${data?data.price_adj:''}">
      </div>
    </div>
    <div class="image-selector" id="sizeImg${id}"></div>
  `;
  document.getElementById('sizeVariantList').appendChild(item);
  item.querySelector('.remove-variant').onclick=()=>item.remove();
  
  // Pre-select images if data provided
  if(data && data.images){
    setTimeout(()=>{
      const selector=item.querySelector('.image-selector');
      const checkboxes=selector.querySelectorAll('.img-checkbox');
      data.images.forEach(imgIdx=>{
        if(checkboxes[imgIdx]){
          checkboxes[imgIdx].classList.add('selected');
        }
      });
    },100);
  }
  
  updateVariantSelectors();
}

function updateVariantSelectors(){
  document.querySelectorAll('.image-selector').forEach(selector=>{
    selector.innerHTML='<p class="small text-muted mb-2">Select images for this variant:</p><div class="d-flex flex-wrap gap-2"></div>';
    const container=selector.querySelector('.d-flex');
    
    allImages.forEach((img,idx)=>{
      const box=document.createElement('div');
      box.className='img-checkbox';
      box.innerHTML=`<img src="${img.src}" alt="Image ${idx+1}">`;
      box.onclick=()=>box.classList.toggle('selected');
      container.appendChild(box);
    });
  });
}

// FORM SUBMISSION
document.getElementById('productForm').addEventListener('submit',function(e){
  // CRITICAL FIX: Update file input before submission
  if(files.length > 0){
    updateFileInput();
  }
  
  const colors=[];
  document.querySelectorAll('#colorVariantList .variant-item').forEach(item=>{
    const id=item.dataset.variantId;
    const variant={
      id:id,
      name:item.querySelector('.color-name').value,
      code:item.querySelector('.color-code').value,
      price_adj:item.querySelector('.color-price').value||0,
      images:[]
    };
    item.querySelectorAll('.img-checkbox.selected').forEach((box,idx)=>{
      const allBoxes=Array.from(item.querySelectorAll('.img-checkbox'));
      const imgIdx=allBoxes.indexOf(box);
      variant.images.push(imgIdx);
    });
    colors.push(variant);
  });

  const sizes=[];
  document.querySelectorAll('#sizeVariantList .variant-item').forEach(item=>{
    const id=item.dataset.variantId;
    const variant={
      id:id,
      name:item.querySelector('.size-name').value,
      price_adj:item.querySelector('.size-price').value||0,
      images:[]
    };
    item.querySelectorAll('.img-checkbox.selected').forEach((box,idx)=>{
      const allBoxes=Array.from(item.querySelectorAll('.img-checkbox'));
      const imgIdx=allBoxes.indexOf(box);
      variant.images.push(imgIdx);
    });
    sizes.push(variant);
  });

  document.getElementById('colorVariantsData').value=JSON.stringify(colors);
  document.getElementById('sizeVariantsData').value=JSON.stringify(sizes);
});

// CRITICAL: Load existing variants on page load
document.addEventListener('DOMContentLoaded', function() {
  // Initialize all images first
  updateAllImages();
  
  // Load existing color variants
  setTimeout(()=>{
    existingColorVariants.forEach(cv => {
      addColorVariant(cv);
    });
    
    // Load existing size variants
    existingSizeVariants.forEach(sv => {
      addSizeVariant(sv);
    });
  }, 500);
});
</script>
{% endblock %}